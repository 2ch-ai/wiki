# Апскейл

**Апскейл (upscale)** - набор техник, предназначенный для того, чтобы увеличить исходное изображение.  

**Апскейлер (upscaler)** - алгоритм или нейронная сеть, увеличивающая исходное изображение.  

### Общие сведения
* [Популярные нейросетевые апскейлеры](./#популярные-апскейлеры)  
* [База данных по апскейлерам](https://openmodeldb.info)  

### Гайды по апскейлу
* [Апскейл через sd_upscale в AUTOMATIC1111](https://rentry.co/sd__upscale)  
* [Про апскейл и инпаинт в AUTOMATIC1111 webui](https://rentry.co/SD_upscale)  
* [Руководство по апскейлу из гайда по вкату](https://rentry.co/2ch_nai_guide#апскейл)  
* [Апскейл с помощью ControlNet в AUTOMATIC1111](https://rentry.co/UpscaleByControl)  

## Для чего нужны апскейлеры

Апскейлеры являются важным инструментом в экосистеме картинко-генеративных нейросетей в связи с двумя обстоятельствами:  

1. Наиболее популярные диффузионные модели не умеют генерировать изображения сразу в высоком разрешении  
2. Диффузионные модели работают с фиксированным разрешением, которое подается на вход  

Таким образом, если сначала каким-то образом увеличить разрешение исходной генерации и, затем, повторно подать её в диффузию в режиме работы с "готовым" изображением, то можно получить качественную картинку в большем разрешении.

Для помощи в решении этой задачи и нужны апскейлеры - они применяются в комбинации и диффузионными моделями для увеличения размера и уровня детализации изображений. Используемый апскейлер заметно влияет на итоговое качество изображения. 

Процесс апскейла, как правило, состоит из двух этапов:  

1. Увеличение изображения апскейлером  
2. Повторный проход диффузионной моделью по увеличенному изображению для сглаживания и увеличения уровня детализации  

Апскейлер не знает ничего о вашем промпте и не использует CLIP/UNet. Это независимая система, которая не использует ничего, кроме исходного изображения.

## Использование апскейлера на примере Hires. fix

Наиболее простым практическим случаем применения апскейлера является увеличение изображения при помощи алгоритма Hires. fix, который сводится к следующему:  

??? info "1. Генерация изображения низкого разрешения при помощи диффузионной модели"
    ![](https://files.catbox.moe/sny1zh.png)

??? info "2. Увеличение изображения апскейлером"
    ![](https://files.catbox.moe/iwnxnl.jpg)

??? info "3. Повторный прогон диффузионной моделью для сглаживания и придания деталей"
    ![](https://files.catbox.moe/kjkmuw.jpg)

## Виды апскейлеров

### Алгоритмические апскейлеры

| Плюсы                               | Минусы            |
| ----------------------------------- | ----------------- |
| ✅ Быстрая скорость работы           | ❌ Низкое качество |
| ✅ Не требуют дополнительных моделей |                   |

Самый простой и быстрый вариант апскейла.

Хоть итоговый результат такого апскейла не такой впечатляющий, как у нейросетевых апскейлеров, всё же следуют помнить, что апскейл - это лишь промежуточный шаг перед повторной обработкой изображения диффузионной моделью, так что при достаточной силе денойза (denoise strength) вся пикселизация и мыло должны уйти.

#### Обычные апскейлеры
Представляют собою различные алгоритмы интерполяции RGB-изображений.

Результат работы будет близок к тому, что вы получите просто увеличивая изображение в Photoshop/Krita/Paint.

* **Nearest** - интерполяция на основе соседних пикселей. Отличается высоким уровнем пикселизации.

* **Lanczos** - интерполяция на основе соседних пикселей и от тех, что чуть дальше. Создаёт плавные переходы.

??? info "Сравнение Nearest и Lanczos"
    | Nearest                                  | Lanczos                                  |
    | ---------------------------------------- | ---------------------------------------- |
    | ![](https://files.catbox.moe/pibo2o.png) | ![](https://files.catbox.moe/f57bud.png) |
    | ![](https://files.catbox.moe/adozji.png) | ![](https://files.catbox.moe/nxbsmr.png) |


!!! tip "Пикселизация или сглаживание"
    Довольно часто "острые" (пиксельные) края могут идти в плюс, поскольку для диффузии они будут являться центрами доделывания деталей, как очаги кристаллизации в растворе.

#### Латентные апскейлеры
Аналогично, представляют собою различные алгоритмы интерполяции. В то время как обычные и нейросетевые апскейлеры работают с RGB-изображениями, латентные апскейлеры работают с [латентным пространством](./vae.md), что позволяет использовать апскейлер без дополнительных конвертаций с применением VAE.

Поскольку латентное пространство представляет собой данные иного вида в сравнении с RGB-изображениями, то и набор доступных алгоритмов интерполяции так же отличается.

Как правило, во время работы латентных апскейлеров необходимо выставлять силу денойза (denoise strength) выше обычных алгоритмических или нейросетевых апскейлеров - в противном случае будет бросаться в глаза сильная размытость изображения после апскейла. 

??? info "Размытие при низком денойзе для латентного апскейлера"

    ![](https://files.catbox.moe/tvgm8l.jpg)

### Нейросетевые апскейлеры (GAN/DAT)

| Плюсы              | Минусы                                      |
| ------------------ | ------------------------------------------- |
| ✅ Высокое качество | ❌ Нужно устанавливать дополнительные модели |
|                     | ❌ Ниже скорость работы, особенно при использовании DAT |

GAN/DAT-апскейлеры - это нейросетевые модели, которые обучали увеличивать изображения низкого разрешения. Качество обычно выше, чем у алгоритмических апскейлеров.

Функциональной разницы между GAN и DAT нет - это просто две различные архитектуры нейросетей для решения одной и той же задачи.

!!! tip "Про DAT"
    DAT является более новой архитектурой по сравнению с ESRGAN. Основанные на нём решения, как правило, более ресурсоёмкие, но более качественные.

    В случае DAT некоторые предпочитают не осуществлять дополнительный проход дифьюзерсами после апскейла, поскольку находят результат такого апскейла достаточно удовлетворительным.

Существует множество других архитектур для апскейлеров, однако, они пока не получили широкого распространения.

Скорость работы апскейлера зависит от архитектуры и размера модели, которые варьируются от менее чем 1Мб до нескольких сотен мегабайт.

#### Популярные апскейлеры  

* [4x AnimeSharp](https://openmodeldb.info/models/4x-AnimeSharp)  
* [4x UltraSharp](https://openmodeldb.info/models/4x-UltraSharp)  
* [4x Remacri](https://openmodeldb.info/models/4x-Remacri)  
* [R-ESRGAN 4x+](https://openmodeldb.info/models/4x-realesrgan-x4plus)  
* [R-ESRGAN 4x+ Anime6B](https://openmodeldb.info/models/4x-realesrgan-x4plus-anime-6b)  
* [SwinIR 4x](https://openmodeldb.info/models/4x-classicalSR-DF2K-s64w8-SwinIR-M)  
* [4x Nomos8kDAT](https://openmodeldb.info/models/4x-Nomos8kDAT) (медленный, но даёт впечатляющие результаты)  

---

Апскейлеры необходимо поместить в соответствующую им директорию в зависимости от архитектуры:

```
/models/ESRGAN
/models/DAT
```

Как правило, информация об архитектуре можно найти на странице деталей апскейлера.

Больше апскейлеров можно найти на <https://openmodeldb.info>