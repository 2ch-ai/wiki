---
status: new
---

# VAE & Latent Space

## Что такое VAE?
**VAE (Variational Autoencoder)** — это нейросеть, которая умеет эффективно сжимать и распаковывать данные.

Запакованные посредством VAE данные называют **latent space**. В русскоязычной среде данный термин обычно переводят как **латентное пространство**.

## Как работает VAE в Stable Diffusion

В случае Stable Diffusion, **VAE** — это нейронная сеть, хранящаяся в формате pt, ckpt или safetensors, которая преобразует RGB-изображение в **латентное пространство** и обратно.

**Латентное пространство** — это то, с чем работает Stable Diffusion во время процесса **семплинга** (sampling), т. е. когда индикатор процесса генерации находится между пустым и полным.

![](https://files.catbox.moe/n8ztu1.PNG)

Для режима **txt2img** VAE используется для создания результирующего изображения после завершения операций семплинга. В режиме **img2img** VAE используется для конвертации входного изображения в латентное пространство перед этапом семплинга и для создания изображения после завершения этапа семплинга.

При кодировании изображения размером 1280x1280 пикселей, в латентном пространстве оно будет представлено в виде массива размером 160x160x4 параметров — по каждой из сторон происходит сжатие в 8 раз.
![](https://files.catbox.moe/78109u.png)

Подобное является возможным по той причине, что, входные данные, как правило, не являются случайными, что позволяет их эффективно сжимать с минимальными потерями.

![](https://files.catbox.moe/uqk1s3.png){ align=right }

При приближении можно заметить, что, на разных "каналах" в латентном пространстве, персонаж находится в немного отличающихся позах, а так же обилие "белого шума". Способ представления изображения в латентном пространстве не является интерпретируемым.

==Для определённых случаев смена VAE может приводить к [значительным изменениям изображения](https://files.catbox.moe/57bpmx.png), так что латентное пространство, очевидно, содержит избыточные данные.==
<br>
<br>
<br>

## Как выбрать и где взять VAE?
!!! danger "Несовместимость VAE от разных базовых моделей"
    VAE от разных базовых моделей (таких как SD 1.X и SDXL) несовместимы между собой без использования дополнительных костылей. Если вашу картинку [жёстко размазало](https://files.catbox.moe/hldjmb.png), то, скорее всего, вы использовали VAE от SDXL для SD 1.X, либо наоборот.

!!! warning "Не используйте стандартный VAE от первого SD"
    При использовании моделей основанных на SD 1.X крайне желательно использовать любой VAE, отличный от стандартного. Причина этого в том, что стандартный VAE имеет тенденцию плодить [артефакты в виде фиолетовых пятен](https://files.catbox.moe/p2f8z5.png).

Технически, Stable Diffusion не может работать без наличия VAE. Если вы выбираете опцию `None` в качестве VAE, будет скачан и использован стандартный VAE, либо же, при наличии, будет использован VAE, вшитый в текущий SD-чекпоинт, что называется термином **baked VAE**.

==Стоит отметить, что любые алгоритмы дообучения SD (Dreambooth, LoRA, LyCORIS) так же осуществляют работу в латентном пространстве. Причиной, почему все процессы связанные с SD работают в латентном пространстве является то, что данный подход позволяет более чем на порядок сократить объём данных во время работы основных нейросетей (CLIP и UNet), что сильно снижает требования к обучению и запуску SD-чекпоинтов.==

==Совместимые с SD 1.X VAE вместе со ссылками на загрузку вы можете увидеть ниже. Наиболее заметным эффектом при смене VAE является яркость изображения. Стандартный NovelAI VAE выдаёт блеклые цвета, поэтому имеет смысл использовать его в том случае, если вы хотите сделать изображения менее яркими.==

Загруженные файлы с VAE необходимо поместить в директорию `%автоматик%\models\VAE`.

| NovelAI VAE | [kl-f8-anime2 VAE](https://civitai.com/models/23906/kl-f8-anime2-vae) | [EMA 560k VAE](https://huggingface.co/stabilityai/sd-vae-ft-ema-original/resolve/main/vae-ft-ema-560000-ema-pruned.safetensors?download=true) | [MSE 840k VAE](https://huggingface.co/stabilityai/sd-vae-ft-mse-original/resolve/main/vae-ft-mse-840000-ema-pruned.safetensors?download=true)
|:-:|:-:|:-:|:-:|
| ![](https://files.catbox.moe/uzvf6j.png) | ![](https://files.catbox.moe/ra1o50.png) | ![](https://files.catbox.moe/0j3r2d.png) | ![](https://files.catbox.moe/gkr4an.png)

!!! info "Прочие VAE"
    Так же существует большое количество файнтьюнов данных VAE, [которые можно найти на civitai](https://civitai.com/search/models?sortBy=models_v5&query=vae).

В отдельных случаях, авторы SD-чекпоинтов помещают информацию о рекомендуемом VAE на странице своей модели в civitai. В этом случае, ссылка на загрузку рекомендуемого VAE будет распологаться под кнопкой загрузки модели. 

![](https://files.catbox.moe/8ucvta.png)

## Настройки и оптимизации
### Вынос настройки VAE на верхнюю панель
Через меню `Settings -> Quicksettings list` возможно вынести настройку VAE на верхнюю панель. Для этого добавьте опцию `sd_vae` в список быстрых настроек. После сохранения и перезагрузки интерфейса, вы увидите настройку SD VAE в верхней части интерфейса, рядом с выпадающим списком SD-чекпоинтов.

![](https://files.catbox.moe/fx2cul.png)

### Перестаём генерировать чёрные квадраты

![](https://files.catbox.moe/dswams.png)

По умолчанию, VAE выполняется с точностью fp16, что криво работает с NovelAI VAE и не работает на видеокартах 16xx поколения. 

Для решения данной проблемы необходимо сменить точность операций VAE на fp32. Это можно осуществить одним из двух способов.

!!! warning "Увеличение потребления VRAM"
    Смена режима точности с fp16 на fp32 неминуемо ведёт к увеличению потребления VRAM в процессе энкодинга/декодинга изображения. Если вы столкнулись с нехватной VRAM после увеличения точности для VAE, попробуйте запустить webui с аргументом `--medvram`, либо же испольуйте Tiled VAE или TAESD (описано ниже).

#### Аргумент запуска --no-half-vae
Добавление аргумента `--no-half-vae` к параметрам запуска в файле webui-user.bat включит режим точности fp32 для VAE.

![](https://files.catbox.moe/xtfwf2.PNG)

#### Опция Automatically revert VAE to 32-bit floats
Активация опции `Automatically revert VAE to 32-bit floats` в настройках автоматика приведёт к запуску VAE в режиме точности fp32 если в режиме fp16 VAE начинает возвращать `NaN` вместо корректных значений.

![](https://files.catbox.moe/gi3jya.PNG)


### Tiled VAE
[[Github]](https://github.com/pkuliyi2015/multidiffusion-upscaler-for-automatic1111) [[Как установить]](https://github.com/pkuliyi2015/multidiffusion-upscaler-for-automatic1111?tab=readme-ov-file#installation)

Расширение **multidiffusion-upscaler-for-automatic1111** предоставляет возможность проводить процесс энкодинга/декодинга изображения по частям, что позволяет значительно сократить объём потребляемой VRAM в момент работы VAE.

- [x] Сокращает потребление VRAM практически без побочных эффектов
- [x] Во многих случаях делает ненужным использование опций `--lowvram` и `--medvram`  
- [x] При использовании highres.fix вы сможете использовать более высокий коэффициент апскейла без вылетов из-за нехватки VRAM  
- [x] В большинстве случаев, вы можете использовать стандартные настройки Tiled VAE без каких либо модификаций  
- [x] Плагин автоматически проставит рекомендуемые настройки размера тайла при первом запуске

!!! info "Не забудьте включить плагин"
    По умолчанию плагин будет выключен на вкладках txt2img/img2img. Не забудьте включить его, раскрыв соответстующую панель настроек в секции Tiled VAE и прожав опцию **Enable**.

!!! tip "Исправление цветов"
    Если вы используете маленький размер тайла и картинка становится серой и нечёткой, включите опцию **Encoder Color Fix**.

!!! tip "CUDA error: out of memory"
    Если вы увидите ошибке о недостатке памяти для CUDA, то просто уменьшите размер одного тайла.  

![](https://files.catbox.moe/9ssauw.png)


### Tiny AutoEncoder for Stable Diffusion (TAESD)
[[Github]](https://github.com/madebyollin/taesd)

**TAESD** представляет собой легковестную реализацию VAE, использующую API обычного VAE от Stable Diffusion (работает с SD1.X и SDXL). TAESD менеет точен, но работает на пару порядков быстрее и требует гораздо меньшее количество VRAM. Эта опция работает с привычными файлами VAE и не требует каких либо дополнительных настроек

| | Обычный VAE (SD VAE) | TAESD |
|-|-|-|
| Параметров в энкодере | 34,163,592 | 1,222,532
| Параметров в декодере | 49,490,179 | 1,222,531
| Хорош для мелких деталей | ✅ | ❌
| Работает моментально | ❌ | ✅

TAESD интегрирован в webui и может быть включён в настройках за пару кликов.  
![](https://files.catbox.moe/3d1xd9.PNG)

Автор TAESD не рекомендует использовать данное решение в том случае, если вам необходимо точное воспроизведение мелких деталей, поскольку TAESD может их искажать.

Пример от автора TAESD:

![](https://raw.githubusercontent.com/madebyollin/taesd/main/images/limitations.jpg)

Пример для аниме:

| SD VAE | TAESD |
|:-:|:-:|
| ![](https://files.catbox.moe/nlrad1.png) | ![](https://files.catbox.moe/wev2we.png) |