# VAE & Latent Space

## Что такое VAE?
**VAE (Varietional Autoencoder)** — это нейросеть, которая умеет эффективно сжимать и распаковывать данные.

Запакованные посредством VAE данные называют **latent space**. В русскоязычной среде данный термин обычно переводят как **латентное пространство**.

## Как работает VAE в Stable Diffusion

В случае Stable Diffusion, **VAE** — это нейронная сеть, которая преобразует RGB-изображение в **латентное пространство** и обратно.

**Латентное пространство** — это то, с чем работает Stable Diffusion во время процесса **семплинга** (sampling), т. е. когда индикатор процесса генерации находится между пустым и полным.

![](https://files.catbox.moe/n8ztu1.PNG)

Для режима **txt2img** VAE используется для создания результирующего изображения после завершения операций семплинга. В режиме **img2img** VAE используется для конвертации входного изображения в латентное пространство перед этапом семлинга и для создания изображения после завершения этапа семплинга.

При кодировании изображения размером 1280x1280 пикселей, в латентном пространстве оно будет представлено в виде массива размером 160x160x4 параметров — по каждой из сторон происходит сжатие в 8 раз.
![](https://files.catbox.moe/78109u.png)  

Подобное является возможным по той причине, что, входные данные, как правило, не являются случайными, что позволяет их эффективно сжимать с минимальными потерями.

При приближении можно заметить, что, на разных каналах в латентном пространстве, персонаж находится в немного отличающихся позах, а так же обилие "белого шума". Способ представления изображения в латентном пространстве не является интерпретируемым.

![](https://files.catbox.moe/uqk1s3.png)  

Для определённых случаев смена VAE может приводить к [координальным изменениям изображения](https://files.catbox.moe/57bpmx.png), так что латентное пространство, очевидно, содержит избыточные данные.

## Как выбрать и где взять VAE?
!!! warning
    VAE от разных базовых моделей (таких как SD 1.X и SDXL) несовместимы между собой без использования дополнительных костылей.
Технически, Stable Diffusion не может работать без наличия VAE. Если вы выбираете опцию `None` в качестве VAE, будет скачан и использован стандартный VAE для выбранной модели.

Совместимые с SD 1.X VAE вместе со ссылками на загрузку вы можете увидеть ниже. Наиболее заметным эффектом при смене VAE является яркость изображения. Стандартный NovelAI VAE выдаёт бледные изображения и его мало кто использует.

| NovelAI VAE | [kl-f8-anime2 VAE](https://civitai.com/models/23906/kl-f8-anime2-vae) | [EMA 560k VAE](https://huggingface.co/stabilityai/sd-vae-ft-ema-original/resolve/main/vae-ft-ema-560000-ema-pruned.safetensors?download=true) | [MSE 840k VAE](https://huggingface.co/stabilityai/sd-vae-ft-mse-original/resolve/main/vae-ft-mse-840000-ema-pruned.safetensors?download=true)
|:-:|:-:|:-:|:-:|
|![](https://files.catbox.moe/uzvf6j.png) | ![](https://files.catbox.moe/ra1o50.png) | ![](https://files.catbox.moe/0j3r2d.png) | ![](https://files.catbox.moe/gkr4an.png)

Так же существует большое количество файнтьюнов данных VAE, [которые можно найти на civitai](https://civitai.com/search/models?sortBy=models_v5&query=vae).

!!! TODO
    Добавить инфу про baked VAE.

При использовании моделей основанных на SD 1.X крайне желательно использовать любой VAE, отличный от стандартного. Причина этого в том, что стандартный VAE имеет тенденцию плодить артефакты в виде фиолетовых пятен, что уже давно стало мемом.

![](https://files.catbox.moe/cf1v4r.jpg)

## Вынос настройки VAE на верхнюю панель
Через меню `Settings -> Quicksettings list` возможно вынести настройку VAE на верхнюю панель. Для этого добавьте опцию `sd_vae` в список быстрых настроек. После сохранения и перезагрузки интерфейса, вы увидите настройку SD VAE в верхней части интерфейса, рядом с выпадающим списком SD-чекпоинтов.

![](https://files.catbox.moe/fx2cul.png)